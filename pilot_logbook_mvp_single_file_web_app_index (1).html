<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pilot Logbook MVP</title>
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 + ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX in the browser (MVP only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js for the monthly hours chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV import -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <link rel="icon" href="data:;base64,=" />
    <style>
      html, body { background: #0b1220; }
      .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); }
      .glass { background: rgba(255,255,255,0.06); }
      .input { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); }
      .btn { background: linear-gradient(135deg,#2563eb,#22d3ee); }
      .btn2 { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.18); }
      .tag { background: rgba(34,211,238,.15); border: 1px solid rgba(34,211,238,.35); color: #a5f3fc; }
    </style>
  </head>
  <body class="text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      // ---- Utilities ----
      function parseTimeToMinutes(t) {
        // Expects "HH:MM" (24h). Returns minutes since midnight or null.
        if (!t) return null;
        const m = /^(\d{1,2}):(\d{2})$/.exec(t.trim());
        if (!m) return null;
        let hh = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
        return hh * 60 + mm;
      }

      function minutesToHHMM(mins) {
        if (mins == null) return "";
        const h = Math.floor(mins / 60);
        const m = Math.round(mins % 60);
        const hh = String(h).padStart(2,"0");
        const mm = String(m).padStart(2,"0");
        return `${hh}:${mm}`;
      }

      function computeBlockTime(depStr, arrStr, overnight=false) {
        const dep = parseTimeToMinutes(depStr);
        const arr = parseTimeToMinutes(arrStr);
        if (dep == null || arr == null) return null;
        let diff = arr - dep;
        if (overnight && diff < 0) diff += 24*60;
        if (!overnight && diff < 0) diff += 24*60; // assume next-day if negative
        return diff;
      }

      function uid() {
        return Math.random().toString(36).slice(2);
      }

      const STORAGE_KEY = "pilot_logbook_mvp_v1";

      function loadFlights() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }

      function saveFlights(flights) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(flights));
      }

      // ---- Components ----
      function StatCard({label, value}) {
        return (
          <div className="card rounded-2xl p-4">
            <div className="text-slate-300 text-sm">{label}</div>
            <div className="text-2xl font-semibold mt-1">{value}</div>
          </div>
        );
      }

      function TopBar({onImportCSV, onExportCSV, onExportPDF, onClearAll}) {
        const fileRef = useRef();
        return (
          <div className="flex flex-col lg:flex-row gap-3 lg:items-center lg:justify-between">
            <div>
              <h1 className="text-2xl font-bold">Pilot Logbook MVP</h1>
              <p className="text-slate-400 text-sm">Fast flight-hour logging with import/export & dashboard</p>
            </div>
            <div className="flex flex-wrap gap-2">
              <button className="btn text-white px-4 py-2 rounded-xl" onClick={()=>fileRef.current?.click()}>Import CSV</button>
              <input type="file" accept=".csv" ref={fileRef} className="hidden" onChange={e=>onImportCSV(e.target.files?.[0])} />
              <button className="btn2 px-4 py-2 rounded-xl" onClick={onExportCSV}>Export CSV</button>
              <button className="btn2 px-4 py-2 rounded-xl" onClick={onExportPDF}>Export PDF</button>
              <button className="btn2 px-4 py-2 rounded-xl" onClick={onClearAll}>Clear All</button>
              <a className="btn2 px-4 py-2 rounded-xl" href="https://www.iata.org/en/programs/ops-infra/flight-operations/" target="_blank" rel="noreferrer">IATA</a>
            </div>
          </div>
        );
      }

      function FlightForm({onAdd}) {
        const [date, setDate] = useState("");
        const [aircraftType, setAircraftType] = useState("");
        const [registration, setRegistration] = useState("");
        const [from, setFrom] = useState("");
        const [to, setTo] = useState("");
        const [dep, setDep] = useState("");
        const [arr, setArr] = useState("");
        const [overnight, setOvernight] = useState(false);
        const [role, setRole] = useState("PIC");
        const [isNight, setIsNight] = useState(false);
        const [remarks, setRemarks] = useState("");

        const blockMins = useMemo(()=>computeBlockTime(dep, arr, overnight), [dep, arr, overnight]);

        function reset() {
          setDate(""); setAircraftType(""); setRegistration(""); setFrom(""); setTo("");
          setDep(""); setArr(""); setOvernight(false); setRole("PIC"); setIsNight(false); setRemarks("");
        }

        function submit(e) {
          e.preventDefault();
          const rec = {
            id: uid(),
            date,
            aircraftType,
            registration,
            from,
            to,
            dep,
            arr,
            overnight,
            role,
            isNight,
            remarks,
            blockMins: blockMins ?? 0
          };
          onAdd(rec);
          reset();
        }

        return (
          <form onSubmit={submit} className="card rounded-2xl p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <div>
              <label className="text-sm text-slate-300">Date</label>
              <input className="input w-full rounded-xl px-3 py-2" type="date" value={date} onChange={e=>setDate(e.target.value)} required />
            </div>
            <div>
              <label className="text-sm text-slate-300">Aircraft Type</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="e.g., A320, DA40" value={aircraftType} onChange={e=>setAircraftType(e.target.value)} required />
            </div>
            <div>
              <label className="text-sm text-slate-300">Registration</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="e.g., HZ-XXX" value={registration} onChange={e=>setRegistration(e.target.value)} />
            </div>
            <div>
              <label className="text-sm text-slate-300">From</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="ICAO/IATA" value={from} onChange={e=>setFrom(e.target.value)} required />
            </div>
            <div>
              <label className="text-sm text-slate-300">To</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="ICAO/IATA" value={to} onChange={e=>setTo(e.target.value)} required />
            </div>
            <div>
              <label className="text-sm text-slate-300">Departure (HH:MM)</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="14:35" value={dep} onChange={e=>setDep(e.target.value)} required />
            </div>
            <div>
              <label className="text-sm text-slate-300">Arrival (HH:MM)</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="16:05" value={arr} onChange={e=>setArr(e.target.value)} required />
            </div>
            <div className="flex items-center gap-2 pt-6">
              <input id="overnight" type="checkbox" className="w-4 h-4" checked={overnight} onChange={e=>setOvernight(e.target.checked)} />
              <label htmlFor="overnight" className="text-slate-300 text-sm">Overnight (arrives next day)</label>
            </div>
            <div>
              <label className="text-sm text-slate-300">Role</label>
              <select className="input w-full rounded-xl px-3 py-2" value={role} onChange={e=>setRole(e.target.value)}>
                <option>PIC</option>
                <option>SIC</option>
                <option>Instructor</option>
                <option>Student</option>
                <option>Dual</option>
                <option>Observer</option>
              </select>
            </div>
            <div className="flex items-center gap-2 pt-6">
              <input id="night" type="checkbox" className="w-4 h-4" checked={isNight} onChange={e=>setIsNight(e.target.checked)} />
              <label htmlFor="night" className="text-slate-300 text-sm">Night</label>
            </div>
            <div className="md:col-span-2 lg:col-span-4">
              <label className="text-sm text-slate-300">Remarks</label>
              <input className="input w-full rounded-xl px-3 py-2" placeholder="Notes..." value={remarks} onChange={e=>setRemarks(e.target.value)} />
            </div>
            <div className="lg:col-span-4 flex justify-end">
              <button className="btn px-5 py-2 rounded-xl text-white">Add Flight</button>
            </div>
            <div className="lg:col-span-4 text-slate-400 text-xs -mt-2">Block time auto-calculates from departure & arrival.</div>
          </form>
        );
      }

      function FlightsTable({flights, onDelete, onEdit}) {
        const [q, setQ] = useState("");
        const filtered = flights.filter(f => {
          const text = (f.date + " " + f.aircraftType + " " + f.registration + " " + f.from + " " + f.to + " " + f.role + " " + f.remarks).toLowerCase();
          return text.includes(q.toLowerCase());
        });

        return (
          <div className="card rounded-2xl p-4">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-3">
              <div className="text-lg font-semibold">Flights</div>
              <input className="input rounded-xl px-3 py-2 w-full md:w-72" placeholder="Search..." value={q} onChange={e=>setQ(e.target.value)} />
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead className="text-slate-300">
                  <tr className="border-b border-slate-700">
                    <th className="text-left p-2">Date</th>
                    <th className="text-left p-2">Aircraft</th>
                    <th className="text-left p-2">Reg</th>
                    <th className="text-left p-2">From</th>
                    <th className="text-left p-2">To</th>
                    <th className="text-left p-2">Dep</th>
                    <th className="text-left p-2">Arr</th>
                    <th className="text-left p-2">Blk</th>
                    <th className="text-left p-2">Role</th>
                    <th className="text-left p-2">Night</th>
                    <th className="text-left p-2">Remarks</th>
                    <th className="text-left p-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.length === 0 && (
                    <tr><td colSpan="12" className="text-slate-400 p-4">No flights yet.</td></tr>
                  )}
                  {filtered.map(f => (
                    <tr key={f.id} className="border-b border-slate-800 hover:bg-white/5">
                      <td className="p-2">{f.date}</td>
                      <td className="p-2">{f.aircraftType}</td>
                      <td className="p-2">{f.registration}</td>
                      <td className="p-2">{f.from}</td>
                      <td className="p-2">{f.to}</td>
                      <td className="p-2">{f.dep}</td>
                      <td className="p-2">{f.arr}</td>
                      <td className="p-2">{minutesToHHMM(f.blockMins)}</td>
                      <td className="p-2"><span className="px-2 py-0.5 rounded-lg tag">{f.role}</span></td>
                      <td className="p-2">{f.isNight ? "Yes" : "No"}</td>
                      <td className="p-2">{f.remarks}</td>
                      <td className="p-2 flex gap-2">
                        <button className="btn2 px-3 py-1 rounded-lg" onClick={()=>onEdit(f.id)}>Edit</button>
                        <button className="btn2 px-3 py-1 rounded-lg" onClick={()=>onDelete(f.id)}>Delete</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      function Dashboard({flights}) {
        const totals = useMemo(()=>{
          const total = flights.reduce((a,b)=>a + (b.blockMins||0), 0);
          const pic = flights.filter(f=>f.role==="PIC").reduce((a,b)=>a + (b.blockMins||0), 0);
          const sic = flights.filter(f=>f.role==="SIC").reduce((a,b)=>a + (b.blockMins||0), 0);
          const night = flights.filter(f=>f.isNight).reduce((a,b)=>a + (b.blockMins||0), 0);
          const byType = {};
          for (const f of flights) {
            byType[f.aircraftType] = (byType[f.aircraftType] || 0) + (f.blockMins||0);
          }
          return { total, pic, sic, night, byType };
        }, [flights]);

        useEffect(()=>{
          const ctx = document.getElementById("hoursChart");
          if (!ctx) return;
          const byMonth = {};
          for (const f of flights) {
            if (!f.date) continue;
            const ym = f.date.slice(0,7); // YYYY-MM
            byMonth[ym] = (byMonth[ym] || 0) + (f.blockMins||0);
          }
          const labels = Object.keys(byMonth).sort();
          const data = labels.map(k=> (byMonth[k]/60).toFixed(2));

          if (window._chart) window._chart.destroy();
          window._chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [{ label: "Hours per Month", data }]
            },
            options: {
              plugins: { legend: { labels: { color: "#e5e7eb" } } },
              scales: {
                x: { ticks: { color: "#e5e7eb" }, grid: { color: "rgba(255,255,255,0.1)" } },
                y: { ticks: { color: "#e5e7eb" }, grid: { color: "rgba(255,255,255,0.1)" } }
              }
            }
          });
        }, [flights]);

        const topTypes = Object.entries(totals.byType).sort((a,b)=>b[1]-a[1]).slice(0,4);

        return (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
            <StatCard label="Total Hours" value={(totals.total/60).toFixed(2)} />
            <StatCard label="PIC Hours" value={(totals.pic/60).toFixed(2)} />
            <StatCard label="SIC Hours" value={(totals.sic/60).toFixed(2)} />
            <StatCard label="Night Hours" value={(totals.night/60).toFixed(2)} />
            <div className="card rounded-2xl p-4 md:col-span-2 lg:col-span-3">
              <canvas id="hoursChart" height="120"></canvas>
            </div>
            <div className="card rounded-2xl p-4">
              <div className="text-slate-300 text-sm mb-2">Top Aircraft Types</div>
              <div className="space-y-2">
                {topTypes.length === 0 && <div className="text-slate-400 text-sm">No data yet.</div>}
                {topTypes.map(([type, mins])=> (
                  <div key={type} className="flex items-center justify-between">
                    <div className="text-sm">{type || "â€”"}</div>
                    <div className="text-sm font-semibold">{(mins/60).toFixed(2)} h</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [flights, setFlights] = useState(loadFlights());
        const [editingId, setEditingId] = useState(null);

        useEffect(()=>{ saveFlights(flights); }, [flights]);

        function addFlight(rec) {
          setFlights([rec, ...flights]);
        }

        function deleteFlight(id) {
          if (!confirm("Delete this flight?")) return;
          setFlights(flights.filter(f=>f.id!==id));
        }

        function startEdit(id) {
          const f = flights.find(x=>x.id===id);
          if (!f) return;
          const date = prompt("Date (YYYY-MM-DD)", f.date) ?? f.date;
          const aircraftType = prompt("Aircraft Type", f.aircraftType) ?? f.aircraftType;
          const registration = prompt("Registration", f.registration) ?? f.registration;
          const from = prompt("From", f.from) ?? f.from;
          const to = prompt("To", f.to) ?? f.to;
          const dep = prompt("Departure HH:MM", f.dep) ?? f.dep;
          const arr = prompt("Arrival HH:MM", f.arr) ?? f.arr;
          const overnight = confirm("Overnight? (OK=yes, Cancel=no)") ? true : false;
          const role = prompt("Role (PIC/SIC/Instructor/Student/Dual/Observer)", f.role) ?? f.role;
          const isNight = confirm("Night? (OK=yes, Cancel=no)") ? true : false;
          const remarks = prompt("Remarks", f.remarks) ?? f.remarks;
          const blockMins = computeBlockTime(dep, arr, overnight) ?? f.blockMins;
          const updated = { ...f, date, aircraftType, registration, from, to, dep, arr, overnight, role, isNight, remarks, blockMins };
          setFlights(flights.map(x=>x.id===id ? updated : x));
        }

        function importCSV(file) {
          if (!file) return;
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              // Expect columns like: date, aircraftType, registration, from, to, dep, arr, overnight, role, isNight, remarks
              const rows = results.data;
              const imported = [];
              for (const r of rows) {
                const rec = {
                  id: uid(),
                  date: (r.date || r.Date || "").trim(),
                  aircraftType: (r.aircraftType || r["Aircraft Type"] || r.Aircraft || "").trim(),
                  registration: (r.registration || r.Registration || r.Reg || "").trim(),
                  from: (r.from || r.From || "").trim(),
                  to: (r.to || r.To || "").trim(),
                  dep: (r.dep || r.Dep || r.Departure || "").trim(),
                  arr: (r.arr || r.Arr || r.Arrival || "").trim(),
                  overnight: (String(r.overnight || r.Overnight || "").toLowerCase()==="true"),
                  role: (r.role || r.Role || "PIC").trim(),
                  isNight: (String(r.isNight || r.Night || "").toLowerCase()==="true"),
                  remarks: (r.remarks || r.Remarks || "").trim(),
                };
                rec.blockMins = computeBlockTime(rec.dep, rec.arr, rec.overnight) ?? 0;
                imported.push(rec);
              }
              setFlights([...imported, ...flights]);
            }
          });
        }

        function exportCSV() {
          const headers = ["date","aircraftType","registration","from","to","dep","arr","overnight","role","isNight","remarks","blockMins"];
          const rows = [headers.join(",")];
          for (const f of flights) {
            rows.push([f.date,f.aircraftType,f.registration,f.from,f.to,f.dep,f.arr,f.overnight,f.role,f.isNight,JSON.stringify(f.remarks||""),f.blockMins].join(","));
          }
          const blob = new Blob([rows.join("\n")], {type: "text/csv;charset=utf-8;"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = "pilot-logbook.csv"; a.click();
          URL.revokeObjectURL(url);
        }

        function exportPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ unit: "pt", format: "a4" });
          doc.setFontSize(14);
          doc.text("Pilot Logbook - Flights", 40, 40);
          doc.setFontSize(10);
          let y = 70;
          const header = ["Date","ACFT","Reg","From","To","Dep","Arr","Blk","Role","Night","Remarks"];
          doc.text(header.join("  |  "), 40, y);
          y += 12;
          doc.line(40, y, 555, y);
          y += 12;
          for (const f of flights.slice(0, 200)) { // limit to first 200 rows for MVP
            const row = [
              f.date, f.aircraftType, f.registration, f.from, f.to,
              f.dep, f.arr, minutesToHHMM(f.blockMins), f.role, f.isNight ? "Y" : "N",
              (f.remarks || "").slice(0,40)
            ].join("  |  ");
            if (y > 780) { doc.addPage(); y = 60; }
            doc.text(row, 40, y);
            y += 14;
          }
          doc.save("pilot-logbook.pdf");
        }

        function clearAll() {
          if (!confirm("This will delete all flights in this browser. Continue?")) return;
          setFlights([]);
          localStorage.removeItem(STORAGE_KEY);
        }

        return (
          <div className="max-w-7xl mx-auto p-4 space-y-4">
            <TopBar onImportCSV={importCSV} onExportCSV={exportCSV} onExportPDF={exportPDF} onClearAll={clearAll} />
            <Dashboard flights={flights} />
            <FlightForm onAdd={addFlight} />
            <FlightsTable flights={flights} onDelete={deleteFlight} onEdit={startEdit} />
            <div className="text-slate-400 text-xs text-center pt-2">
              Data is stored locally in your browser (localStorage). For backups, use Export CSV/PDF.
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
      // Auto-complete registration and set aircraft type
document.getElementById("registration").addEventListener("input", function () {
  let input = this.value.trim().toUpperCase();

  if (input === "") {
    document.getElementById("aircraftType").value = "";
    return;
  }

  // Always prefix with HZ-AS
  let fullReg = "HZ-AS" + input;
  this.value = fullReg;

  // Determine aircraft type
  if (/^[0-9]+$/.test(input.slice(-1))) {
    // Ends with number
    document.getElementById("aircraftType").value = "A320";
  } else if (/^[A-Z]{2}$/.test(input.slice(-2))) {
    // Ends with two letters
    document.getElementById("aircraftType").value = "A321 NEO";
  } else if (/^[A-Z]$/.test(input.slice(-1))) {
    // Ends with single letter
    document.getElementById("aircraftType").value = "A321";
  } else {
    document.getElementById("aircraftType").value = "";
  }
});

    </script>
  </body>
</html>
